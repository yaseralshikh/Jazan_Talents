
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/vfs_fonts.js"></script>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f3f6fd;
      padding: 20px;
    }
    .header {
      background-color: #4a8ef1;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .table-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    table {
      text-align: center;
    }
    .btn-print {
      margin-left: 10px;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="header d-flex justify-content-between align-items-center">
    <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1568x1192.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" height="60" style="filter: brightness(0) invert(1);">
    <h3 class="m-0">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
  </div>

  <div class="row mb-4 no-print">
    <div class="col-md-4">
      <label for="sectorSelect">Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…:</label>
      <select class="form-select" id="sectorSelect">
        <option value="">Ø§Ø®ØªØ± Ù‚Ø·Ø§Ø¹Ù‹Ø§</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="stageSelect">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
      <select class="form-select" id="stageSelect">
        <option value="">Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø©</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="schoolSelect">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</label>
      <select class="form-select" id="schoolSelect">
        <option value="">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©</option>
      </select>
    </div>
  </div>

  <div class="table-card" id="dataTable">
    <div class="text-start mb-3">
    <button class="btn btn-outline-primary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <div id="schoolNameTitle" class="fw-bold fs-5 text-center mb-3"></div>
    <div class="table-responsive" id="table_div"></div>
  </div>

  <script>
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(loadData);

    let allData;
    let dataTable;

    const spreadsheetId = '10R3flKxq0TRXFM7W2K7xoLRxWpNmtu68xEti7d1HP_U';
    const sheetName = 'Data';
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${sheetName}`;

    function loadData() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(rep => {
          const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
          dataTable = new google.visualization.DataTable(jsonData.table);
          allData = dataTable;
          populateFilters();
          filterAndDraw();
        });
    }

    function populateFilters() {
      const sectorSelect = document.getElementById("sectorSelect");
      const stageSelect = document.getElementById("stageSelect");

      const sectors = new Set();
      const stages = new Set();

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        sectors.add(allData.getValue(i, 0));
        stages.add(allData.getValue(i, 1));
      }

      sectors.forEach(s => sectorSelect.innerHTML += `<option value="${s}">${s}</option>`);
      stages.forEach(s => stageSelect.innerHTML += `<option value="${s}">${s}</option>`);

      sectorSelect.addEventListener('change', () => {
        updateSchoolDropdown();
        filterAndDraw();
      });
      stageSelect.addEventListener('change', () => {
        updateSchoolDropdown();
        filterAndDraw();
      });

      document.getElementById("schoolSelect").addEventListener('change', filterAndDraw);
    }

    function updateSchoolDropdown() {
      const sector = document.getElementById("sectorSelect").value;
      const stage = document.getElementById("stageSelect").value;
      const schoolSelect = document.getElementById("schoolSelect");
      schoolSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©</option>`;

      const schools = new Set();
      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        const currentSector = allData.getValue(i, 0);
        const currentStage = allData.getValue(i, 1);
        const currentSchool = allData.getValue(i, 2);
        if ((!sector || currentSector === sector) &&
            (!stage || currentStage === stage)) {
          schools.add(currentSchool);
        }
      }

      schools.forEach(school => {
        schoolSelect.innerHTML += `<option value="${school}">${school}</option>`;
      });
    }

    function filterAndDraw() {
      const sector = document.getElementById("sectorSelect").value;
      const stage = document.getElementById("stageSelect").value;
      const school = document.getElementById("schoolSelect").value;

      const filteredRows = [];

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        const matchSector = !sector || allData.getValue(i, 0) === sector;
        const matchStage = !stage || allData.getValue(i, 1) === stage;
        const matchSchool = !school || allData.getValue(i, 2) === school;

        if (matchSector && matchStage && matchSchool) {
          filteredRows.push(i);
        }
      }

      const view = new google.visualization.DataView(allData);
      view.setRows(filteredRows);
      view.setColumns([3, 4, 5, 6, 7]);

      const numberedData = [["#", "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø¬ÙˆØ§Ù„", "Ø§Ù„ØµÙ", "Ø§Ù„ØªØµÙ†ÙŠÙ"]];
      for (let i = 0; i < view.getNumberOfRows(); i++) {
        numberedData.push([
          i + 1,
          view.getValue(i, 0) || "",
          view.getValue(i, 1) || "",
          view.getValue(i, 2) || "",
          view.getValue(i, 3) || "",
          view.getValue(i, 4) || "",
        ]);
      }

      const finalTable = google.visualization.arrayToDataTable(numberedData);
      const table = new google.visualization.Table(document.getElementById('table_div'));
      table.draw(finalTable, { showRowNumber: false, width: '100%' });

      document.getElementById("schoolNameTitle").innerText = school;
    }

    function exportPDF() {
      const schoolName = document.getElementById("schoolSelect").value || "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";
      const tableRows = document.querySelectorAll("#table_div table tr");
      const body = [];

      tableRows.forEach((row, index) => {
        const cells = row.querySelectorAll("th, td");
        const rowData = [];
        cells.forEach(cell => rowData.push(cell.innerText));
        body.push(rowData);
      });

      const docDefinition = {
        content: [
          { text: schoolName, style: 'header', alignment: 'center' },
          {
            table: {
              headerRows: 1,
              body: body
            },
            layout: 'lightHorizontalLines'
          }
        ],
        defaultStyle: {
          alignment: 'right'
        },
        styles: {
          header: {
            fontSize: 16,
            bold: true,
            margin: [0, 0, 0, 10]
          }
        }
      };

      pdfMake.createPdf(docDefinition).download("students.pdf");
    }
  </script>
</body>
</html>
