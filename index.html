
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عرض بيانات الطلاب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f0f6ff;
      padding: 30px;
    }
    .header {
      background-color: #007bff;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h2 {
      margin: 0;
      font-size: 1.8rem;
    }
    .header img {
      height: 60px;
      filter: brightness(0) invert(1);
    }
    .card-filters {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .table-card {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn-export {
      margin-top: 20px;
    }
    #schoolNameTitle {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    thead {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>عرض بيانات الطلاب</h2>
      <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1568x1192.png" alt="شعار وزارة التعليم">
    </div>

    <div class="card-filters row mb-3">
      <div class="col-md-4">
        <label for="sectorSelect">قطاع التعليم:</label>
        <select class="form-select" id="sectorSelect">
          <option value="">اختر قطاعًا</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="stageSelect">المرحلة الدراسية:</label>
        <select class="form-select" id="stageSelect">
          <option value="">اختر مرحلة</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="schoolSelect">المدرسة:</label>
        <select class="form-select" id="schoolSelect">
          <option value="">اختر مدرسة</option>
        </select>
      </div>
    </div>

    <div class="table-card" id="dataTable">
      <div id="schoolNameTitle"></div>
      <div id="table_div"></div>
    </div>

    <div class="text-center">
      <button class="btn btn-success btn-export" onclick="printCustomTable()">حفظ كـ PDF</button>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(loadData);

    let allData;
    let dataTable;

    const spreadsheetId = '10R3flKxq0TRXFM7W2K7xoLRxWpNmtu68xEti7d1HP_U';
    const sheetName = 'Data';
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${sheetName}`;

    function loadData() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(rep => {
          const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
          dataTable = new google.visualization.DataTable(jsonData.table);
          allData = dataTable;
          populateFilters();
          filterAndDraw();
        });
    }

    function populateFilters() {
      const sectorSelect = document.getElementById("sectorSelect");
      const stageSelect = document.getElementById("stageSelect");

      const sectors = new Set();
      const stages = new Set();

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        sectors.add(allData.getValue(i, 0));
        stages.add(allData.getValue(i, 1));
      }

      sectors.forEach(s => {
        sectorSelect.innerHTML += `<option value="${s}">${s}</option>`;
      });

      stages.forEach(s => {
        stageSelect.innerHTML += `<option value="${s}">${s}</option>`;
      });

      sectorSelect.addEventListener('change', () => {
        updateSchoolDropdown();
        filterAndDraw();
      });

      stageSelect.addEventListener('change', () => {
        updateSchoolDropdown();
        filterAndDraw();
      });

      document.getElementById("schoolSelect").addEventListener('change', filterAndDraw);
    }

    function updateSchoolDropdown() {
      const sector = document.getElementById("sectorSelect").value;
      const stage = document.getElementById("stageSelect").value;
      const schoolSelect = document.getElementById("schoolSelect");
      schoolSelect.innerHTML = `<option value="">اختر مدرسة</option>`;

      const schools = new Set();

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        const currentSector = allData.getValue(i, 0);
        const currentStage = allData.getValue(i, 1);
        const currentSchool = allData.getValue(i, 2);

        if ((!sector || currentSector === sector) &&
            (!stage || currentStage === stage)) {
          schools.add(currentSchool);
        }
      }

      schools.forEach(school => {
        schoolSelect.innerHTML += `<option value="${school}">${school}</option>`;
      });
    }

    function filterAndDraw() {
      const sector = document.getElementById("sectorSelect").value;
      const stage = document.getElementById("stageSelect").value;
      const school = document.getElementById("schoolSelect").value;

      document.getElementById("schoolNameTitle").innerText = school || '';

      const filteredRows = [];

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        const matchSector = !sector || allData.getValue(i, 0) === sector;
        const matchStage = !stage || allData.getValue(i, 1) === stage;
        const matchSchool = !school || allData.getValue(i, 2) === school;

        if (matchSector && matchStage && matchSchool) {
          filteredRows.push(i);
        }
      }

      const view = new google.visualization.DataView(allData);
      view.setRows(filteredRows);
      view.setColumns([3, 4, 5, 6, 7]);

      const numberedData = [['#', 'اسم الطالب', 'الصف', 'التصنيف']];
      for (let i = 0; i < view.getNumberOfRows(); i++) {
        numberedData.push([
          i + 1,
          view.getValue(i, 0) || '',
          view.getValue(i, 3) || '',
          view.getValue(i, 4) || ''
        ]);
      }

      let html = '<table><thead><tr>';
      numberedData[0].forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      for (let i = 1; i < numberedData.length; i++) {
        html += '<tr>';
        numberedData[i].forEach(cell => html += `<td>${cell}</td>`);
        html += '</tr>';
      }
      html += '</tbody></table>';
      document.getElementById('table_div').innerHTML = html;
    }

    function printCustomTable() {
      const title = document.getElementById("schoolNameTitle").innerText;
      const tableHTML = document.getElementById("table_div").innerHTML;

      const win = window.open('', '_blank');
      win.document.write(`
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>تصدير PDF</title>
          <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
          <style>
            body { font-family: 'Cairo', sans-serif; padding: 20px; direction: rtl; }
            h2 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
            thead { background-color: #007bff; color: white; }
          </style>
        </head>
        <body>
          <h2>${title}</h2>
          ${tableHTML}
          
          <script>
            window.addEventListener('load', function () {
              setTimeout(() => {
                window.print();
                window.close();
              }, 500);
            });
          </script>

        </body>
        </html>
      `);
      win.document.close();
    }
  </script>
</body>
</html>
