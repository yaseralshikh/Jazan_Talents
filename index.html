<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بيانات الطلاب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Google Charts API -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      padding: 30px;
    }
    table {
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">عرض بيانات الطلاب</h2>

    <div class="row mb-4">
      <div class="col-md-4">
        <label for="sectorSelect">قطاع التعليم:</label>
        <select class="form-select" id="sectorSelect">
          <option value="">اختر قطاعًا</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="stageSelect">المرحلة الدراسية:</label>
        <select class="form-select" id="stageSelect">
          <option value="">اختر مرحلة</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="schoolSelect">المدرسة:</label>
        <select class="form-select" id="schoolSelect">
          <option value="">اختر مدرسة</option>
        </select>
      </div>
    </div>

    <div class="mb-4 text-center">
      <button class="btn btn-primary" onclick="filterData()">بحث</button>
    </div>

    <div id="table_div"></div>
  </div>

  <script>
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(loadData);

    let allData;
    let dataTable;

    // استبدل YOUR_SHEET_ID بمعرف الجدول الحقيقي
    const spreadsheetId = '10R3flKxq0TRXFM7W2K7xoLRxWpNmtu68xEti7d1HP_U'; // ضع ID الصحيح للجدول
    const sheetName = 'Data'; // اسم الورقة داخل Google Sheets
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?sheet=${sheetName}`;
    // const sheetUrl = 'https://docs.google.com/spreadsheets/d/10R3flKxq0TRXFM7W2K7xoLRxWpNmtu68xEti7d1HP_U/gviz/tq?sheet=Data';

    function loadData() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(rep => {
          const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
          dataTable = new google.visualization.DataTable(jsonData.table);
          allData = dataTable;
          populateFilters();
          drawTable(allData); // عرض كامل البيانات أولًا
        });
    }

    function populateFilters() {
      const sectorSelect = document.getElementById("sectorSelect");
      const stageSelect = document.getElementById("stageSelect");

      const sectors = new Set();
      const stages = new Set();

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        sectors.add(allData.getValue(i, 0)); // قطاع التعليم
        stages.add(allData.getValue(i, 1));  // المرحلة الدراسية
      }

      sectors.forEach(s => {
        sectorSelect.innerHTML += `<option value="${s}">${s}</option>`;
      });

      stages.forEach(s => {
        stageSelect.innerHTML += `<option value="${s}">${s}</option>`;
      });

      sectorSelect.addEventListener('change', updateSchoolDropdown);
    }

    function updateSchoolDropdown() {
      const sector = document.getElementById("sectorSelect").value;
      const schoolSelect = document.getElementById("schoolSelect");
      schoolSelect.innerHTML = `<option value="">اختر مدرسة</option>`;

      if (!sector) return;

      const schools = new Set();

      for (let i = 0; i < allData.getNumberOfRows(); i++) {
        if (allData.getValue(i, 0) === sector) {
          schools.add(allData.getValue(i, 2)); // المدرسة
        }
      }

      schools.forEach(school => {
        schoolSelect.innerHTML += `<option value="${school}">${school}</option>`;
      });
    }

    function filterData() {
      const sector = document.getElementById("sectorSelect").value;
      const stage = document.getElementById("stageSelect").value;
      const school = document.getElementById("schoolSelect").value;

      const view = new google.visualization.DataView(allData);
      const filters = [];

      if (sector) filters.push({ column: 0, value: sector });
      if (stage) filters.push({ column: 1, value: stage });
      if (school) filters.push({ column: 2, value: school });

      view.setRows(allData.getFilteredRows(filters));

      // عرض فقط الأعمدة من اسم الطالب إلى التصنيف
      view.setColumns([3, 4, 5, 6, 7]); // أعمدة: اسم الطالب، السجل المدني، الجوال، الصف، التصنيف

      drawTable(view);
    }

    function drawTable(view) {
      const table = new google.visualization.Table(document.getElementById('table_div'));
      table.draw(view, { showRowNumber: false, width: '100%', height: 'auto' });
    }
  </script>
</body>
</html>
